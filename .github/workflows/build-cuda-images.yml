name: Build and Push Images

# Trigger on push to main, tags, or manual dispatch
on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type: cuda, slim (default), or all'
        required: false
        default: 'slim'
        type: choice
        options:
          - slim
          - cuda
          - all

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository_owner }}/pyrrhus-jupyter

jobs:
  build-cpu:
    name: Build CPU Image
    runs-on: ubuntu-latest
    if: false  # Disabled - only building slim for now
    permissions:
      contents: read
      packages: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Free up disk space
        run: |
          echo "=== Initial disk usage ==="
          df -h
          echo "=== Removing unnecessary packages ==="
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          sudo apt-get autoremove -y
          sudo apt-get clean
          echo "=== Final disk usage ==="
          df -h
        
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Extract metadata (tags, labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=cpu
            type=raw,value=cpu-latest
            type=raw,value=cpu-{{sha}}
            type=semver,pattern={{version}}-cpu
            type=semver,pattern={{major}}.{{minor}}-cpu
          labels: |
            org.opencontainers.image.title=Pyrrhus JupyterLab CPU
            org.opencontainers.image.description=Lightweight CPU-only JupyterLab with NeMo Data Designer
      
      - name: Build and push CPU image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=cpu
          cache-to: type=gha,mode=max,scope=cpu
          platforms: linux/amd64
          
      - name: Generate image summary
        if: github.event_name != 'pull_request'
        run: |
          echo "### ðŸ³ CPU Image Built Successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Type:** CPU-only (lightweight)" >> $GITHUB_STEP_SUMMARY
          echo "**Size:** ~2GB (vs ~6GB for CUDA)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Pull command:**" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:cpu" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run command:**" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "docker run --rm -p 8888:8888 ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:cpu" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  build-slim:
    name: Build Slim Image
    runs-on: ubuntu-latest
    if: github.event.inputs.build_type != 'cuda'  # Build slim by default (disabled cpu)
    permissions:
      contents: read
      packages: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Free up disk space
        run: |
          echo "=== Initial disk usage ==="
          df -h
          echo "=== Removing unnecessary packages ==="
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          sudo apt-get autoremove -y
          sudo apt-get clean
          echo "=== Final disk usage ==="
          df -h
        
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Extract metadata (tags, labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=slim
            type=raw,value=slim-latest
            type=raw,value=slim-{{sha}}
            type=semver,pattern={{version}}-slim
            type=semver,pattern={{major}}.{{minor}}-slim
          labels: |
            org.opencontainers.image.title=Pyrrhus JupyterLab Slim
            org.opencontainers.image.description=Ultra-lightweight CPU-only JupyterLab with NeMo Data Designer (Python 3.12)
            python.version=3.12
      
      - name: Build and push slim image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.slim
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=slim
          cache-to: type=gha,mode=max,scope=slim
          platforms: linux/amd64
          
      - name: Generate image summary
        if: github.event_name != 'pull_request'
        run: |
          echo "### ðŸ³ Slim Image Built Successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Type:** Slim CPU-only (ultra-lightweight)" >> $GITHUB_STEP_SUMMARY
          echo "**Python Version:** 3.12" >> $GITHUB_STEP_SUMMARY
          echo "**Size:** ~1.5-2GB (vs ~2.5-3GB for CPU, ~6GB for CUDA)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Pull command:**" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:slim" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run command:**" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "docker run --rm -p 8888:8888 ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:slim" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  build-matrix:
    name: Build CUDA ${{ matrix.cuda_version }}
    runs-on: ubuntu-latest
    if: github.event.inputs.build_type == 'cuda' || github.event.inputs.build_type == 'all'  # Only on explicit request
    permissions:
      contents: read
      packages: write
      
    strategy:
      fail-fast: false
      matrix:
        # CUDA versions to build (v12 only)
        cuda_version: ['12.1']
        include:
          # Map CUDA version to Ubuntu version
          - cuda_version: '12.1'
            ubuntu_version: '22.04'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Free up disk space
        run: |
          echo "=== Initial disk usage ==="
          df -h
          echo "=== Removing unnecessary packages ==="
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          sudo apt-get autoremove -y
          sudo apt-get clean
          echo "=== Final disk usage ==="
          df -h
        
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:latest
            network=host
        
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Extract metadata (tags, labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=cuda-${{ matrix.cuda_version }}
            type=raw,value=cuda-${{ matrix.cuda_version }}-latest
            type=raw,value=cuda-${{ matrix.cuda_version }}-{{sha}}
            type=semver,pattern={{version}}-cuda-${{ matrix.cuda_version }}
            type=semver,pattern={{major}}.{{minor}}-cuda-${{ matrix.cuda_version }}
          labels: |
            org.opencontainers.image.title=Pyrrhus JupyterLab CUDA ${{ matrix.cuda_version }}
            org.opencontainers.image.description=NVIDIA-branded JupyterLab with GPU dashboards and CUDA ${{ matrix.cuda_version }} support
            cuda.version=${{ matrix.cuda_version }}
            ubuntu.version=${{ matrix.ubuntu_version }}
      
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.cuda
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            CUDA_VERSION=${{ matrix.cuda_version }}
            UBUNTU_VERSION=${{ matrix.ubuntu_version }}
          cache-from: type=gha,scope=cuda-${{ matrix.cuda_version }}
          cache-to: type=gha,mode=max,scope=cuda-${{ matrix.cuda_version }}
          platforms: linux/amd64
          
      - name: Generate image summary
        if: github.event_name != 'pull_request'
        run: |
          echo "### ðŸ³ CUDA Image Built Successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**CUDA Version:** ${{ matrix.cuda_version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Ubuntu Version:** ${{ matrix.ubuntu_version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Size:** ~6GB" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Pull command:**" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:cuda-${{ matrix.cuda_version }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run command:**" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "docker run --rm --gpus all -p 8888:8888 ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:cuda-${{ matrix.cuda_version }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  tag-latest:
    name: Tag Latest Images
    needs: [build-cpu, build-slim, build-matrix]
    runs-on: ubuntu-latest
    if: |
      always() && 
      github.event_name != 'pull_request' && 
      github.ref == 'refs/heads/main' &&
      (needs.build-cpu.result == 'success' || needs.build-slim.result == 'success' || needs.build-matrix.result == 'success')
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Pull and re-tag latest images
        run: |
          # Tag slim as 'latest' (smallest, most compatible)
          if docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:slim 2>/dev/null; then
            docker tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:slim \
                       ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
            docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
            echo "Tagged slim image as 'latest'"
          # Fallback to CPU if slim not available
          elif docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:cpu 2>/dev/null; then
            docker tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:cpu \
                       ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
            docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
            echo "Tagged CPU image as 'latest'"
          fi
          
          # Also tag CUDA 12.1 as 'cuda-latest' if it exists
          if docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:cuda-12.1 2>/dev/null; then
            docker tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:cuda-12.1 \
                       ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:cuda-latest
            docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:cuda-latest
            echo "Tagged CUDA 12.1 as 'cuda-latest'"
          fi
          
      - name: Create summary
        run: |
          echo "### âœ… All Images Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Available tags:" >> $GITHUB_STEP_SUMMARY
          echo "- **Slim (default):** \`latest\`, \`slim\`, \`slim-latest\` (~1.5-2GB, Python 3.12)" >> $GITHUB_STEP_SUMMARY
          echo "- **CPU:** \`cpu\`, \`cpu-latest\` (~2.5-3GB)" >> $GITHUB_STEP_SUMMARY
          echo "- **CUDA 12.1:** \`cuda-12.1\`, \`cuda-12.1-latest\`, \`cuda-latest\` (~6GB)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Quick Start (Slim):**" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "docker run --rm -p 8888:8888 ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Quick Start (GPU):**" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "docker run --rm --gpus all -p 8888:8888 ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:cuda-latest" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "View packages at: https://github.com/${{ github.repository_owner }}?tab=packages" >> $GITHUB_STEP_SUMMARY

